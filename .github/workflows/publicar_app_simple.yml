name: 📦 Publicar App desde Repos Privado

permissions:
  contents: write  # 👈 Esto permite hacer push en el repo

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: "Nombre de la app"
        required: true
      version:
        description: "Versión"
        required: true
      file_url:
        description: "URL directa del release privado"
        required: true
      platform:
        description: "Plataforma"
        required: true
        default: "Android"

jobs:
  publicar:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}

    steps:
      - name: 🧩 Checkout del repositorio público
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PUBLIC_REPO_TOKEN }} # 👈 importante también aquí

      - name: 📁 Preparar carpeta
        run: |
          SAFE_APP=$(echo "${{ github.event.inputs.app_name }}" | tr ' ' '_' )
          SAFE_PLATFORM=$(echo "${{ github.event.inputs.platform }}" | tr ' ' '_' )
          mkdir -p "apps/$SAFE_APP/$SAFE_PLATFORM"

      - name: 📥 Descargar build desde repo privado
        run: |
          SAFE_APP=$(echo "${{ github.event.inputs.app_name }}" | tr ' ' '_' )
          SAFE_PLATFORM=$(echo "${{ github.event.inputs.platform }}" | tr ' ' '_' )
          cd "apps/$SAFE_APP/$SAFE_PLATFORM"

          echo "Descargando build desde: ${{ github.event.inputs.file_url }}"
          curl -L -H "Authorization: token $GH_TOKEN" \
               -o "${SAFE_APP}_${SAFE_PLATFORM}_${{ github.event.inputs.version }}.apk" \
               "${{ github.event.inputs.file_url }}"

      - name: 📝 Actualizar README con nueva app
        run: |
          APP="${{ github.event.inputs.app_name }}"
          VER="${{ github.event.inputs.version }}"
          PLATFORM="${{ github.event.inputs.platform }}"
          SAFE_APP=$(echo "$APP" | tr ' ' '_' )
          SAFE_PLATFORM=$(echo "$PLATFORM" | tr ' ' '_' )
          FILE_PATH="apps/$SAFE_APP/$SAFE_PLATFORM/${SAFE_APP}_${SAFE_PLATFORM}_${VER}.apk"

          LINE="| $APP | $PLATFORM | $VER | [Descargar]($FILE_PATH) |"
          if ! grep -q "$FILE_PATH" README.md; then
            echo "$LINE" >> README.md
          fi

      - name: 💾 Commit y push de cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "📦 Publicada ${{ github.event.inputs.app_name }} v${{ github.event.inputs.version }}"
          git push
