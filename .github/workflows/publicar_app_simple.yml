name: Download and Copy Release to Public Repo

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'URL del archivo a descargar (ej: https://github.com/usuario/repo/releases/download/v1.0.0/app.apk)'
        required: true
        type: string
      app_name:
        description: 'Nombre de la aplicaci√≥n'
        required: true
        type: string
        default: 'MyApp'
      version:
        description: 'Versi√≥n del archivo (ej: 1.0.0)'
        required: true
        type: string
        default: '1.0.0'
      public_repo_url:
        description: 'URL del repositorio p√∫blico (ej: https://github.com/usuario/repo)'
        required: true
        type: string
      release_notes:
        description: 'Notas del release (opcional)'
        required: false
        type: string
        default: ''

jobs:
  download-and-copy:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          echo "üìã Configuraci√≥n del workflow:"
          echo "URL del archivo: ${{ github.event.inputs.file_url }}"
          echo "App: ${{ github.event.inputs.app_name }}"
          echo "Versi√≥n: ${{ github.event.inputs.version }}"
          echo "Repo p√∫blico: ${{ github.event.inputs.public_repo_url }}"

      - name: Validate URL
        run: |
          FILE_URL="${{ github.event.inputs.file_url }}"
          
          echo "üîç Validando URL..."
          
          # Validar que sea una URL v√°lida
          if [[ ! "$FILE_URL" =~ ^https?:// ]]; then
            echo "‚ùå Error: La URL debe comenzar con http:// o https://"
            exit 1
          fi
          
          # Validar que contenga /download/
          if [[ ! "$FILE_URL" =~ /download/ ]]; then
            echo "‚ùå Error: La URL debe ser una URL de descarga"
            exit 1
          fi
          
          # Validar que tenga extensi√≥n de archivo
          if [[ ! "$FILE_URL" =~ \.[a-zA-Z0-9]+$ ]]; then
            echo "‚ùå Error: La URL debe terminar con una extensi√≥n de archivo (.apk, .exe, .dmg, etc)"
            exit 1
          fi
          
          # Validar que no tenga placeholders
          if [[ "$FILE_URL" =~ __.*__ ]]; then
            echo "‚ùå Error: La URL contiene placeholders (__)"
            echo "   Aseg√∫rate de reemplazar v/__ con la versi√≥n real (ej: v1.0.5)"
            exit 1
          fi
          
          echo "‚úÖ URL v√°lida: $FILE_URL"

      - name: Download file
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
          PRIVATE_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          mkdir -p downloads
          cd downloads
          
          FILE_URL="${{ github.event.inputs.file_url }}"
          
          echo "üì• Descargando archivo desde: $FILE_URL"
          
          # Usar token para autenticaci√≥n si el repo es privado
          TOKEN="${PRIVATE_TOKEN:-$GITHUB_TOKEN}"
          
          # Descargar el archivo con autenticaci√≥n
          for i in {1..3}; do
            curl -L \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/octet-stream" \
              "$FILE_URL" \
              -o "temp_file" \
              --fail \
              -s
            
            if [ $? -eq 0 ]; then
              # Obtener el nombre del archivo de la URL
              FILENAME=$(basename "$FILE_URL")
              mv "temp_file" "$FILENAME"
              echo "‚úÖ Archivo descargado exitosamente"
              break
            fi
            
            if [ $i -lt 3 ]; then
              echo "‚ö†Ô∏è  Intento $i fall√≥, reintentando..."
              sleep 2
            fi
          done
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Error descargando el archivo despu√©s de 3 intentos"
            echo "üìù Verifica que:"
            echo "   - La URL es correcta"
            echo "   - Tienes permisos para acceder al repositorio privado"
            echo "   - El token PRIVATE_REPO_TOKEN est√° configurado"
            exit 1
          fi
          
          echo "‚úÖ Archivo descargado:"
          ls -lah

      - name: Rename and organize file
        id: organize
        run: |
          cd downloads
          
          APP_NAME="${{ github.event.inputs.app_name }}"
          VERSION="${{ github.event.inputs.version }}"
          
          # Obtener el archivo descargado
          ORIGINAL_FILE=$(ls -1 | head -1)
          
          if [ -z "$ORIGINAL_FILE" ]; then
            echo "‚ùå Error: No se encontr√≥ el archivo descargado"
            exit 1
          fi
          
          echo "üìÑ Archivo original: $ORIGINAL_FILE"
          
          # Extraer la extensi√≥n
          EXTENSION="${ORIGINAL_FILE##*.}"
          
          # Crear nombre del archivo: app_nombre_version.extension
          NEW_FILENAME="${APP_NAME}_${VERSION}.${EXTENSION}"
          
          echo "new_filename=$NEW_FILENAME" >> $GITHUB_OUTPUT
          echo "extension=$EXTENSION" >> $GITHUB_OUTPUT
          
          # Renombrar el archivo
          mv "$ORIGINAL_FILE" "$NEW_FILENAME"
          
          echo "‚úÖ Archivo renombrado a: $NEW_FILENAME"
          ls -lah

      - name: Extract public repo
        id: extract_repo
        run: |
          URL="${{ github.event.inputs.public_repo_url }}"
          # Convertir https://github.com/usuario/repo a usuario/repo
          REPO=$(echo "$URL" | sed 's|.*github.com/||' | sed 's|\.git$||')
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "Repositorio p√∫blico: $REPO"

      - name: Checkout public repo
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.extract_repo.outputs.repo }}
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          path: public-repo

      - name: Organize files in public repo
        run: |
          cd public-repo
          
          APP_NAME="${{ github.event.inputs.app_name }}"
          NEW_FILENAME="${{ steps.organize.outputs.new_filename }}"
          
          # Crear estructura: app/nombre_app/archivo
          mkdir -p "app/$APP_NAME"
          
          # Copiar el archivo
          cp "../downloads/$NEW_FILENAME" "app/$APP_NAME/$NEW_FILENAME"
          
          echo "üìÅ Estructura creada:"
          tree app/ || find app/ -type f

      - name: Commit and push to public repo
        run: |
          cd public-repo
          
          APP_NAME="${{ github.event.inputs.app_name }}"
          VERSION="${{ github.event.inputs.version }}"
          NEW_FILENAME="${{ steps.organize.outputs.new_filename }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add "app/$APP_NAME/$NEW_FILENAME"
          
          git commit -m "Add $APP_NAME $VERSION release" \
            -m "File: app/$APP_NAME/$NEW_FILENAME" \
            -m "Released by automated workflow"
          
          git push
          
          echo "‚úÖ Archivo publicado en el repositorio p√∫blico"

      - name: Summary
        if: success()
        run: |
          APP_NAME="${{ github.event.inputs.app_name }}"
          VERSION="${{ github.event.inputs.version }}"
          NEW_FILENAME="${{ steps.organize.outputs.new_filename }}"
          PUBLIC_REPO="${{ steps.extract_repo.outputs.repo }}"
          
          echo "## ‚úÖ Operaci√≥n completada exitosamente"
          echo ""
          echo "üì¶ **Aplicaci√≥n**: $APP_NAME"
          echo "üìå **Versi√≥n**: $VERSION"
          echo "üìÑ **Archivo**: $NEW_FILENAME"
          echo "üìç **Ubicaci√≥n**: app/$APP_NAME/$NEW_FILENAME"
          echo "üîó **Repositorio**: $PUBLIC_REPO"
          echo ""
          echo "El archivo ha sido descargado, renombrado y publicado correctamente."
