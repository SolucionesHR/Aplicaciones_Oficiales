name: 🧪 Debug Private Download (GH CLI)

on:
  workflow_dispatch:
    inputs:
      repo:
        description: "Repositorio privado (formato: owner/repo)"
        required: true
        default: "SolucionesHR/mercados_cuba_delivery"
      tag:
        description: "Tag o versión del release"
        required: true
        default: "v1.0.5"
      pattern:
        description: "Patrón del nombre del archivo a descargar (por ejemplo *.apk)"
        required: true
        default: "mensajero.apk"

jobs:
  debug-gh-download:
    runs-on: ubuntu-latest

    steps:
      - name: 🏁 Iniciar flujo
        run: echo "🔍 Iniciando descarga privada con gh release download..."

      - name: 🔑 Verificar autenticación actual
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          echo "🔐 Verificando autenticación de GH CLI..."
          gh auth status || echo "⚠️ GH CLI aún no autenticado, pero GH_TOKEN está disponible."

      - name: 📦 Descargar asset desde release privado
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          echo "📥 Descargando desde ${{ github.event.inputs.repo }} - tag ${{ github.event.inputs.tag }}"
          gh release download \
            ${{ github.event.inputs.tag }} \
            --repo "${{ github.event.inputs.repo }}" \
            --pattern "${{ github.event.inputs.pattern }}" \
            --clobber

      - name: 🧾 Verificar archivo descargado
        run: |
          echo "📂 Archivos descargados:"
          ls -lh
          echo "🔍 Información detallada del archivo:"
          file "${{ github.event.inputs.pattern }}" || echo "⚠️ No se encontró el archivo esperado."
          echo "✅ Si el tamaño del archivo es >0, la descarga fue exitosa."
