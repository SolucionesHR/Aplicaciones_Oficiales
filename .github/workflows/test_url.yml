name: 🧪 Debug Private Download

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "URL del archivo en el repositorio privado (release asset)"
        required: true
        default: "https://github.com/SolucionesHR/mercados_cuba_delivery/releases/download/v1.0.5/mensajero.apk"
      output_name:
        description: "Nombre del archivo de salida"
        required: true
        default: "test.apk"

jobs:
  debug-download:
    runs-on: ubuntu-latest

    steps:
      - name: 🏁 Iniciar flujo
        run: echo "🔍 Iniciando descarga privada desde GitHub Release..."

      - name: 🔑 Configurar token
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          echo "Últimos 4 caracteres del token: ${GH_TOKEN: -4}"
          echo "Verificando conexión con GitHub API..."
          curl -s -H "Authorization: Bearer $GH_TOKEN" https://api.github.com/user | jq '.login'

      - name: 🧪 Debug download with verbose curl
        env:
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          echo "Intentando descargar archivo desde:"
          echo "${{ github.event.inputs.repo_url }}"
          curl -v \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/octet-stream" \
            -L "${{ github.event.inputs.repo_url }}" \
            -o "${{ github.event.inputs.output_name }}"

      - name: 📦 Verificar archivo descargado
        run: |
          echo "Listando archivos en el directorio actual..."
          ls -lh
          echo "Detalles del archivo descargado:"
          file "${{ github.event.inputs.output_name }}"
